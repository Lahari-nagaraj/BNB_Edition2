<%- include('partials/header') %>

<div class="hero">
  <h2>ğŸ›ï¸ Public Budget Transparency Portal</h2>
  <p>Explore approved public budgets with complete transparency</p>

  <!-- Filter Form -->
  <form method="get" class="filter-form" id="searchForm">
    <input type="text" name="q" placeholder="ğŸ” Search by name, department, state, or city... (spelling mistakes OK!)" value="<%= searchQuery %>" id="searchInput">

    <select name="status">
      <option value="">ğŸ“Š All Status</option>
      <option value="draft" <%= status==='draft' ? 'selected':'' %>>ğŸ“ Draft</option>
      <option value="pending" <%= status==='pending' ? 'selected':'' %>>â³ Pending</option>
      <option value="approved" <%= status==='approved' ? 'selected':'' %>>âœ… Approved</option>
      <option value="active" <%= status==='active' ? 'selected':'' %>>ğŸŸ¢ Active</option>
      <option value="completed" <%= status==='completed' ? 'selected':'' %>>ğŸ Completed</option>
    </select>

    <select name="state" id="stateSelect">
      <option value="">ğŸ“ All States</option>
      <% states.forEach(state => { %>
        <option value="<%= state %>" <%= userState===state ? 'selected':'' %>><%= state %></option>
      <% }) %>
    </select>

    <select name="city" id="citySelect">
      <option value="">ğŸ™ï¸ All Cities</option>
      <% cities.forEach(city => { %>
        <option value="<%= city %>" <%= userCity===city ? 'selected':'' %>><%= city %></option>
      <% }) %>
    </select>

    <select name="department">
      <option value="">ğŸ¢ All Departments</option>
      <% departments.forEach(dept => { %>
        <option value="<%= dept %>" <%= department===dept ? 'selected':'' %>><%= dept %></option>
      <% }) %>
    </select>

    <button type="submit">ğŸ” Search</button>
    <button type="button" onclick="clearFilters()">ğŸ—‘ï¸ Clear</button>
  </form>
</div>

<!-- Search Results Info -->
<% if (searchQuery || userState || userCity || department || status) { %>
  <div class="search-results-info <%= budgets.length === 0 ? 'no-results' : '' %>">
    <% if (budgets.length > 0) { %>
      <strong>ğŸ” Found <%= budgets.length %> budget<%= budgets.length !== 1 ? 's' : '' %></strong>
      <% if (searchQuery) { %> for "<%= searchQuery %>"<% } %>
      <% if (status) { %> with status "<%= status %>"<% } %>
      <% if (userState) { %> in <%= userState %><% } %>
      <% if (userCity) { %>, <%= userCity %><% } %>
      <% if (department) { %> from <%= department %> department<% } %>
    <% } else { %>
      <strong>âŒ No budgets found</strong>
      <% if (searchQuery) { %> for "<%= searchQuery %>"<% } %>
      <% if (status) { %> with status "<%= status %>"<% } %>
      <% if (userState) { %> in <%= userState %><% } %>
      <% if (userCity) { %>, <%= userCity %><% } %>
      <% if (department) { %> from <%= department %> department<% } %>
      <br><small>Try adjusting your search criteria or clearing filters to see all budgets.</small>
    <% } %>
  </div>
<% } %>

<!-- Budget Cards -->
<div class="cards">
  <% budgets.forEach(budget=>{ %>
  <div class="card budget-card">
    <div class="card-header">
      <h3><%= budget.name %></h3>
      <div class="status-badges">
        <span class="status-badge status-<%= budget.status %>"><%= budget.status %></span>
        <span class="type-badge type-<%= budget.type.toLowerCase() %>"><%= budget.type %></span>
      </div>
    </div>

    <% if (budget.aiSummary) { %>
      <div class="ai-summary-preview">
        <div class="ai-icon">ğŸ¤–</div>
        <p class="ai-text"><%= budget.aiSummary.substring(0,100) %>...</p>
      </div>
    <% } %>

    <div class="budget-info">
      <p><strong>ğŸ¢ Department:</strong> <%= budget.department %></p>
      <p><strong>ğŸ“ State:</strong> <%= budget.state %></p>
      <p><strong>ğŸ’° Total:</strong> <span class="amount-display" data-amount="<%= budget.totalBudget %>">â‚¹<%= budget.totalBudget.toLocaleString() %></span></p>
      <p><strong>ğŸ“… Year:</strong> <%= budget.fiscalYear %></p>
    </div>

    <div class="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" style="width: <%= Math.min(100, (budget.spent/budget.totalBudget*100)) %>%"></div>
      </div>
      <p class="spending-info">
        <span class="spent">Spent: <span class="amount-display" data-amount="<%= budget.spent %>">â‚¹<%= budget.spent.toLocaleString() %></span></span>
        <span class="remaining">Remaining: <span class="amount-display" data-amount="<%= budget.remaining %>">â‚¹<%= budget.remaining.toLocaleString() %></span></span>
      </p>
    </div>

    <div class="card-actions">
      <a href="/budget/<%= budget._id %>"><button>ğŸ“‹ View</button></a>
      <a href="/budget/<%= budget._id %>/visualization"><button class="btn-ai">ğŸ“Š Analytics & Visualization</button></a>
      <button class="btn-verify" onclick="showBudgetVerification('<%= budget._id %>')">ğŸ” Verify</button>
    </div>
    <div class="budget-links">
      <a href="/budgets/state/<%= budget.state %>" class="link-state">ğŸ“ <%= budget.state %></a>
      <a href="/budgets/department/<%= budget.department %>" class="link-department">ğŸ¢ <%= budget.department %></a>
    </div>
    
    <!-- Recent Transactions for this Budget -->
    <div class="budget-transactions">
      <h4>ğŸ’° Recent Transactions</h4>
      <% if(budget.recentTransactions && budget.recentTransactions.length > 0) { %>
        <div class="mini-transactions">
          <% budget.recentTransactions.slice(0, 3).forEach(transaction => { %>
            <div class="mini-transaction">
              <div class="transaction-info">
                <span class="transaction-desc"><%= transaction.description %></span>
                <span class="transaction-amount amount-display" data-amount="<%= transaction.amount %>">â‚¹<%= transaction.amount.toLocaleString() %></span>
              </div>
              <div class="transaction-meta">
                <span class="transaction-status status-<%= transaction.status %>"><%= transaction.status %></span>
                <div class="transaction-icons">
                  <% if(transaction.receipt && transaction.receipt.url) { %>
                    <a href="<%= transaction.receipt.url %>" target="_blank" class="receipt-link">ğŸ“„</a>
                  <% } %>
                  <% if(transaction.blockchainId) { %>
                    <span class="blockchain-mini" title="Blockchain Verified">â›“ï¸</span>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
        <div class="view-all-transactions">
          <a href="/budget/<%= budget._id %>" class="btn-view-all">View All Transactions</a>
        </div>
      <% } else { %>
        <div class="no-transactions">
          <p>No transactions yet</p>
        </div>
      <% } %>
    </div>
  </div>
  <% }) %>
</div>


<!-- Pagination -->
<% if (pagination && pagination.totalPages > 1) { %>
<div class="pagination-container">
  <div class="pagination-info">
    <p>Showing <%= ((pagination.currentPage - 1) * 8) + 1 %>-<%= Math.min(pagination.currentPage * 8, pagination.totalBudgets) %> of <%= pagination.totalBudgets %> budgets</p>
  </div>
  
  <div class="pagination">
    <% if (pagination.hasPrev) { %>
      <a href="?<%= new URLSearchParams({...req.query, page: pagination.prevPage}).toString() %>" class="pagination-btn prev-btn">â† Previous</a>
    <% } %>
    
    <div class="pagination-numbers">
      <% 
        const startPage = Math.max(1, pagination.currentPage - 2);
        const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
      %>
      
      <% if (startPage > 1) { %>
        <a href="?<%= new URLSearchParams({...req.query, page: 1}).toString() %>" class="pagination-number">1</a>
        <% if (startPage > 2) { %>
          <span class="pagination-ellipsis">...</span>
        <% } %>
      <% } %>
      
      <% for (let i = startPage; i <= endPage; i++) { %>
        <a href="?<%= new URLSearchParams({...req.query, page: i}).toString() %>" 
           class="pagination-number <%= i === pagination.currentPage ? 'active' : '' %>"><%= i %></a>
      <% } %>
      
      <% if (endPage < pagination.totalPages) { %>
        <% if (endPage < pagination.totalPages - 1) { %>
          <span class="pagination-ellipsis">...</span>
        <% } %>
        <a href="?<%= new URLSearchParams({...req.query, page: pagination.totalPages}).toString() %>" class="pagination-number"><%= pagination.totalPages %></a>
      <% } %>
    </div>
    
    <% if (pagination.hasNext) { %>
      <a href="?<%= new URLSearchParams({...req.query, page: pagination.nextPage}).toString() %>" class="pagination-btn next-btn">Next â†’</a>
    <% } %>
  </div>
</div>
<% } %>

<!-- Include AI Assistant -->
<%- include('ai') %>

<script src="/js/location.js"></script>

<script>
function showBudgetVerification(budgetId) {
    const modal = document.createElement('div');
  modal.className = 'verification-modal';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ” Budget Verification</h3>
        <button onclick="closeVerification()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <p>This budget has been verified for:</p>
        <ul>
          <li>âœ… Authentic source documents</li>
          <li>âœ… Proper authorization</li>
          <li>âœ… Accurate calculations</li>
          <li>âœ… Compliance with regulations</li>
        </ul>
        <div class="verification-details">
          <p><strong>Verification Status:</strong> <span class="verified">VERIFIED</span></p>
          <p><strong>Verified By:</strong> System Administrator</p>
          <p><strong>Verification Date:</strong> ${new Date().toLocaleDateString()}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeVerification()" class="btn-primary">Close</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
    const style = document.createElement('style');
  style.textContent = `
    .verification-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }
    .modal-body {
      padding: 1rem;
    }
    .modal-footer {
      padding: 1rem;
      border-top: 1px solid #e2e8f0;
      text-align: right;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .verified {
      color: #10b981;
      font-weight: bold;
    }
    .verification-details {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 5px;
      margin-top: 1rem;
    }
  `;
  document.head.appendChild(style);
}

function closeVerification() {
  const modal = document.querySelector('.verification-modal');
  if (modal) {
    modal.remove();
  }
}

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('verification-modal')) {
    closeVerification();
  }
});

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('stateSelect').value = '';
  document.getElementById('citySelect').value = '';
  document.querySelector('select[name="department"]').value = '';
  document.querySelector('select[name="status"]').value = '';
  document.getElementById('searchForm').submit();
}
</script>

<%- include('partials/footer') %>
