<%- include('partials/header') %>

<div class="hero">
  <h2>🏛️ Public Budget Transparency Portal</h2>
  <p>Explore approved public budgets with complete transparency</p>

  <!-- Filter Form -->
  <form method="get" class="filter-form" id="searchForm">
    <input type="text" name="q" placeholder="🔍 Search by name, department, state, or city..." value="<%= searchQuery %>" id="searchInput">

    <select name="state" id="stateSelect">
      <option value="">📍 All States</option>
      <% states.forEach(state => { %>
        <option value="<%= state %>" <%= userState===state ? 'selected':'' %>><%= state %></option>
      <% }) %>
    </select>

    <select name="city" id="citySelect">
      <option value="">🏙️ All Cities</option>
      <% cities.forEach(city => { %>
        <option value="<%= city %>" <%= userCity===city ? 'selected':'' %>><%= city %></option>
      <% }) %>
    </select>

    <select name="department">
      <option value="">🏢 All Departments</option>
      <% departments.forEach(dept => { %>
        <option value="<%= dept %>" <%= department===dept ? 'selected':'' %>><%= dept %></option>
      <% }) %>
    </select>

    <select name="status">
      <option value="">📊 All Status</option>
      <% statuses.forEach(stat => { %>
        <option value="<%= stat %>" <%= status===stat ? 'selected':'' %>><%= stat %></option>
      <% }) %>
    </select>

    <button type="submit">🔍 Search</button>
    <button type="button" onclick="clearFilters()">🗑️ Clear</button>
  </form>
</div>

<!-- Search Results Info -->
<% if (searchQuery || userState || userCity || department || status) { %>
  <div class="search-results-info <%= budgets.length === 0 ? 'no-results' : '' %>">
    <% if (budgets.length > 0) { %>
      <strong>🔍 Found <%= budgets.length %> budget<%= budgets.length !== 1 ? 's' : '' %></strong>
      <% if (searchQuery) { %> for "<%= searchQuery %>"<% } %>
      <% if (userState) { %> in <%= userState %><% } %>
      <% if (userCity) { %>, <%= userCity %><% } %>
      <% if (department) { %> from <%= department %> department<% } %>
      <% if (status) { %> with <%= status %> status<% } %>
    <% } else { %>
      <strong>❌ No budgets found</strong>
      <% if (searchQuery) { %> for "<%= searchQuery %>"<% } %>
      <% if (userState) { %> in <%= userState %><% } %>
      <% if (userCity) { %>, <%= userCity %><% } %>
      <% if (department) { %> from <%= department %> department<% } %>
      <% if (status) { %> with <%= status %> status<% } %>
      <br><small>Try adjusting your search criteria or clearing filters to see all budgets.</small>
    <% } %>
  </div>
<% } %>

<!-- Budget Cards -->
<div class="cards">
  <% budgets.forEach(budget=>{ %>
  <div class="card budget-card">
    <div class="card-header">
      <h3><%= budget.name %></h3>
      <span class="status-badge status-<%= budget.status %>"><%= budget.status %></span>
    </div>

    <% if (budget.aiSummary) { %>
      <div class="ai-summary-preview">
        <div class="ai-icon">🤖</div>
        <p class="ai-text"><%= budget.aiSummary.substring(0,100) %>...</p>
      </div>
    <% } %>

    <div class="budget-info">
      <p><strong>🏢 Department:</strong> <%= budget.department %></p>
      <p><strong>📍 State:</strong> <%= budget.state %></p>
      <p><strong>💰 Total:</strong> ₹<%= budget.totalBudget.toLocaleString() %></p>
      <p><strong>📅 Year:</strong> <%= budget.fiscalYear %></p>
    </div>

    <div class="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" style="width:<%= (budget.spent/budget.totalBudget*100) %>%"></div>
      </div>
      <p class="spending-info">
        <span class="spent">Spent: ₹<%= budget.spent.toLocaleString() %></span>
        <span class="remaining">Remaining: ₹<%= budget.remaining.toLocaleString() %></span>
      </p>
    </div>

    <div class="card-actions">
      <a href="/budget/<%= budget._id %>"><button>📋 View</button></a>
      <a href="/budget/<%= budget._id %>/enhanced"><button class="btn-ai">🤖 AI Enhanced</button></a>
      <button class="btn-verify" onclick="showBudgetVerification('<%= budget._id %>')">🔍 Verify</button>
    </div>
  </div>
  <% }) %>
</div>

<!-- Include AI Assistant -->
<%- include('ai') %>

<script src="/js/location.js"></script>

<script>
function showBudgetVerification(budgetId) {
  // Create verification modal
  const modal = document.createElement('div');
  modal.className = 'verification-modal';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>🔍 Budget Verification</h3>
        <button onclick="closeVerification()" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <p>This budget has been verified for:</p>
        <ul>
          <li>✅ Authentic source documents</li>
          <li>✅ Proper authorization</li>
          <li>✅ Accurate calculations</li>
          <li>✅ Compliance with regulations</li>
        </ul>
        <div class="verification-details">
          <p><strong>Verification Status:</strong> <span class="verified">VERIFIED</span></p>
          <p><strong>Verified By:</strong> System Administrator</p>
          <p><strong>Verification Date:</strong> ${new Date().toLocaleDateString()}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeVerification()" class="btn-primary">Close</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Add modal styles
  const style = document.createElement('style');
  style.textContent = `
    .verification-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }
    .modal-body {
      padding: 1rem;
    }
    .modal-footer {
      padding: 1rem;
      border-top: 1px solid #e2e8f0;
      text-align: right;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .verified {
      color: #10b981;
      font-weight: bold;
    }
    .verification-details {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 5px;
      margin-top: 1rem;
    }
  `;
  document.head.appendChild(style);
}

function closeVerification() {
  const modal = document.querySelector('.verification-modal');
  if (modal) {
    modal.remove();
  }
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('verification-modal')) {
    closeVerification();
  }
});
</script>

<%- include('partials/footer') %>
