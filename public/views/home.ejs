<%- include('partials/header') %>

<div class="hero">
  <h2>🏛️ Public Budget Transparency Portal</h2>
  <p>Explore approved public budgets with complete transparency</p>

  <!-- Filter Form -->
  <form method="get" class="filter-form" id="searchForm">
    <input type="text" name="q" placeholder="🔍 Search by name, department, state, or city..." value="<%= searchQuery %>" id="searchInput">

    <select name="state" id="stateSelect">
      <option value="">📍 All States</option>
      <% states.forEach(state => { %>
        <option value="<%= state %>" <%= userState===state ? 'selected':'' %>><%= state %></option>
      <% }) %>
    </select>

    <select name="city" id="citySelect">
      <option value="">🏙️ All Cities</option>
      <% cities.forEach(city => { %>
        <option value="<%= city %>" <%= userCity===city ? 'selected':'' %>><%= city %></option>
      <% }) %>
    </select>

    <select name="department">
      <option value="">🏢 All Departments</option>
      <% departments.forEach(dept => { %>
        <option value="<%= dept %>" <%= department===dept ? 'selected':'' %>><%= dept %></option>
      <% }) %>
    </select>

    <select name="status">
      <option value="">📊 All Status</option>
      <% statuses.forEach(stat => { %>
        <option value="<%= stat %>" <%= status===stat ? 'selected':'' %>><%= stat %></option>
      <% }) %>
    </select>

    <button type="submit">🔍 Search</button>
    <button type="button" onclick="clearFilters()">🗑️ Clear</button>
  </form>
</div>

<!-- Search Results Info -->
<% if (searchQuery || userState || userCity || department || status) { %>
  <div class="search-results-info <%= budgets.length === 0 ? 'no-results' : '' %>">
    <% if (budgets.length > 0) { %>
      <strong>🔍 Found <%= budgets.length %> budget<%= budgets.length !== 1 ? 's' : '' %></strong>
      <% if (searchQuery) { %> for "<%= searchQuery %>"<% } %>
      <% if (userState) { %> in <%= userState %><% } %>
      <% if (userCity) { %>, <%= userCity %><% } %>
      <% if (department) { %> from <%= department %> department<% } %>
      <% if (status) { %> with <%= status %> status<% } %>
    <% } else { %>
      <strong>❌ No budgets found</strong>
      <% if (searchQuery) { %> for "<%= searchQuery %>"<% } %>
      <% if (userState) { %> in <%= userState %><% } %>
      <% if (userCity) { %>, <%= userCity %><% } %>
      <% if (department) { %> from <%= department %> department<% } %>
      <% if (status) { %> with <%= status %> status<% } %>
      <br><small>Try adjusting your search criteria or clearing filters to see all budgets.</small>
    <% } %>
  </div>
<% } %>

<!-- Budget Cards -->
<div class="cards">
  <% budgets.forEach(budget=>{ %>
  <div class="card budget-card">
    <div class="card-header">
      <h3><%= budget.name %></h3>
      <span class="status-badge status-<%= budget.status %>"><%= budget.status %></span>
    </div>

    <% if (budget.aiSummary) { %>
      <div class="ai-summary-preview">
        <div class="ai-icon">🤖</div>
        <p class="ai-text"><%= budget.aiSummary.substring(0,100) %>...</p>
      </div>
    <% } %>

    <div class="budget-info">
      <p><strong>🏢 Department:</strong> <%= budget.department %></p>
      <p><strong>📍 State:</strong> <%= budget.state %></p>
      <p><strong>💰 Total:</strong> ₹<%= budget.totalBudget.toLocaleString() %></p>
      <p><strong>📅 Year:</strong> <%= budget.fiscalYear %></p>
    </div>

    <div class="progress-section">
      <div class="progress-bar">
        <div class="progress-fill" style="width:<%= (budget.spent/budget.totalBudget*100) %>%"></div>
      </div>
      <p class="spending-info">
        <span class="spent">Spent: ₹<%= budget.spent.toLocaleString() %></span>
        <span class="remaining">Remaining: ₹<%= budget.remaining.toLocaleString() %></span>
      </p>
    </div>

    <div class="card-actions">
      <a href="/budget/<%= budget._id %>"><button>📋 View</button></a>
      <a href="/budget/<%= budget._id %>/enhanced"><button class="btn-ai">🤖 AI Enhanced</button></a>
      <button class="btn-verify" onclick="showBudgetVerification('<%= budget._id %>')">🔍 Verify</button>
    </div>
  </div>
  <% }) %>
</div>

<!-- Include AI Assistant -->
<%- include('ai') %>

<script src="/js/location.js"></script>

<%- include('partials/footer') %>
